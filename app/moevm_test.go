package app_test

import (
	"bytes"
	"testing"

	"github.com/stretchr/testify/require"

	gethcmn "github.com/ethereum/go-ethereum/common"

	"github.com/smartbch/smartbch/internal/bigutils"
	"github.com/smartbch/smartbch/internal/testutils"
)

func TestInternalTxCalls(t *testing.T) {
	// ../testdata/basic/contracts/InternalTxs.sol
	contract1CreationBytecode := testutils.HexToBytes(`0x608060405234801561001057600080fd5b506040516106d83803806106d8833981810160405281019061003291906100d0565b81600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050610155565b6000815190506100ca8161013e565b92915050565b600080604083850312156100e357600080fd5b60006100f1858286016100bb565b9250506020610102858286016100bb565b9150509250929050565b60006101178261011e565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6101478161010c565b811461015257600080fd5b50565b610574806101646000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80634af6b5c21461005c57806361bc221a1461007a578063a11a1f3614610098578063a27eaec2146100c8578063c952aa9c146100f8575b600080fd5b610064610116565b60405161007191906103d6565b60405180910390f35b61008261013c565b60405161008f91906103f1565b60405180910390f35b6100b260048036038101906100ad9190610366565b610142565b6040516100bf91906103f1565b60405180910390f35b6100e260048036038101906100dd9190610366565b61022c565b6040516100ef91906103f1565b60405180910390f35b610100610316565b60405161010d91906103d6565b60405180910390f35b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60005481565b60006064826101519190610462565b600080828254610161919061040c565b92505081905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663a27eaec26001846101b3919061040c565b6040518263ffffffff1660e01b81526004016101cf91906103f1565b602060405180830381600087803b1580156101e957600080fd5b505af11580156101fd573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610221919061038f565b506000549050919050565b600060648261023b9190610462565b60008082825461024b919061040c565b92505081905550600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663e73620c360018461029d919061040c565b6040518263ffffffff1660e01b81526004016102b991906103f1565b602060405180830381600087803b1580156102d357600080fd5b505af11580156102e7573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061030b919061038f565b506000549050919050565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008135905061034b81610527565b92915050565b60008151905061036081610527565b92915050565b60006020828403121561037857600080fd5b60006103868482850161033c565b91505092915050565b6000602082840312156103a157600080fd5b60006103af84828501610351565b91505092915050565b6103c1816104bc565b82525050565b6103d0816104ee565b82525050565b60006020820190506103eb60008301846103b8565b92915050565b600060208201905061040660008301846103c7565b92915050565b6000610417826104ee565b9150610422836104ee565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610457576104566104f8565b5b828201905092915050565b600061046d826104ee565b9150610478836104ee565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156104b1576104b06104f8565b5b828202905092915050565b60006104c7826104ce565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b610530816104ee565b811461053b57600080fd5b5056fea2646970667358221220312cbdc143502365eedd0f99b6f638f0d4c456847f4caaa869e6baadceae205964736f6c63430008000033`)
	contract2CreationBytecode := testutils.HexToBytes(`0x608060405234801561001057600080fd5b5060405161050f38038061050f8339818101604052810190610032919061008e565b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050610100565b600081519050610088816100e9565b92915050565b6000602082840312156100a057600080fd5b60006100ae84828501610079565b91505092915050565b60006100c2826100c9565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6100f2816100b7565b81146100fd57600080fd5b50565b6104008061010f6000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806361bc221a14610046578063a27eaec214610064578063c952aa9c14610094575b600080fd5b61004e6100b2565b60405161005b919061027d565b60405180910390f35b61007e600480360381019061007991906101f2565b6100b8565b60405161008b919061027d565b60405180910390f35b61009c6101a2565b6040516100a99190610262565b60405180910390f35b60005481565b600060c8826100c791906102ee565b6000808282546100d79190610298565b92505081905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663e73620c36001846101299190610298565b6040518263ffffffff1660e01b8152600401610145919061027d565b602060405180830381600087803b15801561015f57600080fd5b505af1158015610173573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610197919061021b565b506000549050919050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000813590506101d7816103b3565b92915050565b6000815190506101ec816103b3565b92915050565b60006020828403121561020457600080fd5b6000610212848285016101c8565b91505092915050565b60006020828403121561022d57600080fd5b600061023b848285016101dd565b91505092915050565b61024d81610348565b82525050565b61025c8161037a565b82525050565b60006020820190506102776000830184610244565b92915050565b60006020820190506102926000830184610253565b92915050565b60006102a38261037a565b91506102ae8361037a565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156102e3576102e2610384565b5b828201905092915050565b60006102f98261037a565b91506103048361037a565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048311821515161561033d5761033c610384565b5b828202905092915050565b60006103538261035a565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6103bc8161037a565b81146103c757600080fd5b5056fea2646970667358221220ba7a8c75945e03701209621faafb9fe743637602d800f08c649797bc180a67b564736f6c63430008000033`)
	contract3CreationBytecode := testutils.HexToBytes(`0x608060405234801561001057600080fd5b5061025e806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c806361bc221a1461003b578063e73620c314610059575b600080fd5b610043610089565b604051610050919061010d565b60405180910390f35b610073600480360381019061006e91906100d5565b61008f565b604051610080919061010d565b60405180910390f35b60005481565b600061012c8261009f919061017e565b6000808282546100af9190610128565b925050819055506000549050919050565b6000813590506100cf81610211565b92915050565b6000602082840312156100e757600080fd5b60006100f5848285016100c0565b91505092915050565b610107816101d8565b82525050565b600060208201905061012260008301846100fe565b92915050565b6000610133826101d8565b915061013e836101d8565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610173576101726101e2565b5b828201905092915050565b6000610189826101d8565b9150610194836101d8565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156101cd576101cc6101e2565b5b828202905092915050565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b61021a816101d8565b811461022557600080fd5b5056fea264697066735822122062aa7d99849223333a5fe9c460bf40fb8cd1144b301a4376e553db05d863cab564736f6c63430008000033`)

	key, addr := testutils.GenKeyAndAddr()
	_app := testutils.CreateTestApp(key)
	defer _app.Destroy()

	tx1, _, contract3Addr := _app.DeployContractInBlock(key, contract3CreationBytecode)
	_app.EnsureTxSuccess(tx1.Hash())
	println(contract3Addr.String())

	tx2, _, contract2Addr := _app.DeployContractInBlock(key,
		joinBytes(contract2CreationBytecode, make([]byte, 12), contract3Addr[:]))
	_app.EnsureTxSuccess(tx2.Hash())
	println(contract2Addr.String())

	tx3, _, contract1Addr := _app.DeployContractInBlock(key,
		joinBytes(contract1CreationBytecode, make([]byte, 12), contract2Addr[:], make([]byte, 12), contract3Addr[:]))
	_app.EnsureTxSuccess(tx3.Hash())
	println(contract1Addr.String())

	// contract1.call2() => contract2.call3() => contract3.callMe()
	callData := joinBytes(testutils.HexToBytes("0xa11a1f36"), bigutils.NewU256(123).PaddedBytes(32))
	tx4, _ := _app.MakeAndExecTxInBlock(key, contract1Addr, 0, callData)
	_app.EnsureTxSuccess(tx4.Hash())
	moTx4 := _app.GetTx(tx4.Hash())
	require.Len(t, moTx4.InternalTxCalls, 3)
	require.Len(t, moTx4.InternalTxReturns, 3)
	require.Equal(t, int32(0), moTx4.InternalTxCalls[0].Depth)
	require.Equal(t, addr, gethcmn.Address(moTx4.InternalTxCalls[0].Sender))
	require.Equal(t, contract1Addr, gethcmn.Address(moTx4.InternalTxCalls[0].Destination))
	require.Equal(t, callData, moTx4.InternalTxCalls[0].Input)
	require.Equal(t, bigutils.NewU256(123*100).PaddedBytes(32), moTx4.InternalTxReturns[2].Output)
	callData2 := joinBytes(testutils.HexToBytes("0xa27eaec2"), bigutils.NewU256(124).PaddedBytes(32))
	require.Equal(t, int32(1), moTx4.InternalTxCalls[1].Depth)
	require.Equal(t, contract1Addr, gethcmn.Address(moTx4.InternalTxCalls[1].Sender))
	require.Equal(t, contract2Addr, gethcmn.Address(moTx4.InternalTxCalls[1].Destination))
	require.Equal(t, callData2, moTx4.InternalTxCalls[1].Input)
	require.Equal(t, bigutils.NewU256(124*200).PaddedBytes(32), moTx4.InternalTxReturns[1].Output)
	callData3 := joinBytes(testutils.HexToBytes("0xe73620c3"), bigutils.NewU256(125).PaddedBytes(32))
	require.Equal(t, int32(2), moTx4.InternalTxCalls[2].Depth)
	require.Equal(t, contract2Addr, gethcmn.Address(moTx4.InternalTxCalls[2].Sender))
	require.Equal(t, contract3Addr, gethcmn.Address(moTx4.InternalTxCalls[2].Destination))
	require.Equal(t, callData3, moTx4.InternalTxCalls[2].Input)
	require.Equal(t, bigutils.NewU256(125*300).PaddedBytes(32), moTx4.InternalTxReturns[0].Output)
}

func joinBytes(a ...[]byte) []byte {
	return bytes.Join(a, nil)
}
